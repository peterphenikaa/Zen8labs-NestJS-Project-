doctype html
html
  head
    title Instagram Dashboard Clone
    link(rel='stylesheet', href='/css/dashboard.css')
  body
    .dashboard
      aside.sidebar
        h1.logo Instagram
        nav.menu
          ul
            li Trang chủ
            li Tìm kiếm
            li Khám phá
            li Reels
            li Tin nhắn
            li Thông báo
            li Tạo
            li Trang cá nhân
            li Xem thêm
            li Của Meta
          button#logoutBtn(type='button', style='margin:16px 0;padding:8px 16px;background:#e74c3c;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:16px;') Đăng xuất
      main.content
        .header
          // Thêm phần hiển thị user để tránh lỗi khi JS truy cập
          h2#userEmail Chào mừng
      footer.footer
        p © 2025 INSTAGRAM FROM META

  script.
    // Token data từ server
    const tokenData = !{JSON.stringify(tokenData || {})};
    // cú pháp template engine render nguyên nội dung tokenData ra
    // đây là data server response lại để lưu vào localStorage 

    // Kiểm tra token khi trang được load
    document.addEventListener('DOMContentLoaded', function() {
      // Lưu token vào localStorage nếu có
      if (tokenData && tokenData.accessToken) {
        localStorage.setItem('accessToken', tokenData.accessToken);
        localStorage.setItem('refreshToken', tokenData.refreshToken);
        localStorage.setItem('expiresAt', tokenData.expiresAt);
        localStorage.setItem('tokenType', tokenData.tokenType);
        localStorage.setItem('crsfToken', tokenData.crsfToken);
        console.log('Token data saved to localStorage:', tokenData);
      }
      
      loadUserInfo();
      checkTokenValidity();
      
      // Kiểm tra token định kỳ mỗi 5 giây
      setInterval(checkTokenValidity, 5000);

      // Gắn sự kiện click cho nút Đăng xuất
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
          logoutBtn.addEventListener('click', logout);
      }
    });

    function loadUserInfo() {
      // Hiển thị thông tin user (guard để tránh lỗi nếu element không tồn tại)
      const el = document.getElementById('userEmail');
      if (el) {
        el.textContent = `Chào mừng bạn!`;
      }
    }

    function checkTokenValidity() {
      const accessToken = localStorage.getItem('accessToken');
      const expiresAt = localStorage.getItem('expiresAt');
      
      if (!accessToken || !expiresAt) {
        console.log('No token found, redirecting to login');
        redirectToLogin();
        return;
      }

      // Kiểm tra token có hết hạn không
      try {
        const payload = JSON.parse(atob(accessToken.split('.')[1]));
        const currentTime = Math.floor(Date.now() / 1000);
        
        console.log('Token expires at:', payload.exp, 'Current time:', currentTime);
        
        if (payload.exp < currentTime) {
          console.log('Token expired, redirecting to login');
          redirectToLogin();
        }
      } catch (error) {
        console.error('Invalid token format:', error);
        redirectToLogin();
      }
    }

    async function logout() {
      try {
        // Gọi API logout để xóa refresh token
        await fetch('/v1/auth/logout', {
          method: 'POST', // nói rõ đây là request post
          headers: { 
            'Content-Type': 'application/json', // báo cho server biết đây là json 
          },
          body: JSON.stringify({ refreshToken: localStorage.getItem('refreshToken') })
          // dữ liệu gửi kèm theo request 
          // JSON.stringify là chuyển từ object sang json 
        });
      } catch (error) {
        console.error('Error during logout:', error);
      } finally {
        // Xóa localStorage và redirect
        redirectToLogin();
      }
    }

    function redirectToLogin() {
      // Xóa localStorage
      localStorage.removeItem('accessToken');
      localStorage.removeItem('refreshToken');
      localStorage.removeItem('expiresAt');
      localStorage.removeItem('tokenType');
      localStorage.removeItem('crsfToken');
      
      // Redirect về login
      window.location.href = '/v1/auth/login';
    }

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }

  // Chat client scripts removed
